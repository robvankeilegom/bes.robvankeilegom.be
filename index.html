<html>
<head>
<meta charset="utf-8" />

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.css">
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

<!-- jQuery library -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<!-- Latest compiled JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="node_modules/chart.js/dist/Chart.min.js"></script>
<style>
  body {
    margin-top: 50px;
  }
</style>
</head>
<body>
<div class="col-lg-2">
  <div class="form-group">
    <label for="usr">Naam</label>
    <input type="text" class="form-control" id="name" value="Voorbeeld 1">
  </div>
  <div class="form-group">
    <label for="usr">Toerental</label>
    <input type="number" class="form-control" id="mt" value="7700">
  </div>
  <div class="form-group">
    <label for="usr">diff. verhouding</label>
    <input type="number" class="form-control" id="dv" value="4.428">
  </div>
  <div class="form-group">
    <label for="usr">Bandomtrek</label>
    <input type="number" class="form-control" id="bo" value="1.79">
  </div>
  <div class="form-group">
    <label for="usr">Versnelling 1</label>
    <input type="number" class="form-control versnelling" id="v1" value="2.923">
  </div>
  <div class="form-group">
    <label for="usr">Versnelling 2</label>
    <input type="number" class="form-control versnelling" id="v2" value="1.882">
  </div>
  <div class="form-group">
    <label for="usr">Versnelling 3</label>
    <input type="number" class="form-control versnelling" id="v3" value="1.36">
  </div>
  <div class="form-group">
    <label for="usr">Versnelling 4</label>
    <input type="number" class="form-control versnelling" id="v4" value="1.068">
  </div>
  <div class="form-group">
    <label for="usr">Versnelling 5</label>
    <input type="number" class="form-control versnelling" id="v5" value="0.864">
  </div>
  <div class="form-group">
    <button type="button" class="btn btn-success btn-block fullwidth" id="save">Voeg toe</button>
  </div>
</div>

<div class="col-lg-8">
  <div class="col-lg-12">
    <canvas id="myChart"></canvas>
  </div>
  <div class="col-lg-12" id="list"></div>
</div>
<script>
  $(function() {
    updateGraph();
  });

  var ctx = document.getElementById("myChart").getContext('2d');
  var myChart;
  var colors = [
    '#ffb3ba',
    '#ffdfba',
    '#ffffba',
    '#baffc9',
    '#bae1ff',
  ];
  var datasets = [];

  $("input").keyup(function() {
    updateGraph();
  });

  $('#save').on('click', function() {
    updateGraph(true);
  });

  function updateGraph(addNew) {
    addNew = addNew || false;
    if (datasets.length !== 0 & addNew === false) {
      datasets.pop();
    }
    var color = (datasets.length % 5);
    var dataset = {
      label: $('#name').val(),
      data: [],
      backgroundColor: 'rgba(0, 0, 0, 0)',
      borderWidth: 4,
      borderColor: colors[color],
      showLine: true,
      tension: 0,
    }
    if (myChart && typeof myChart.destroy === 'function') {
      myChart.destroy();
    }
    dataset.data.push({
      x: 0,
      y: 0
    });

    var dataElement;
    var lastSpeed;

    $('.versnelling').each(function(index) {
      var v = $(this).val();
      if (v === '0') {
        return;
      }
      var mt = parseInt($('#mt').val());
      var dv = $('#dv').val();
      var bo = $('#bo').val();
      var x;

      x = ((mt / dv / v) * (bo * 60)) / 1000;
      if (dataElement !== undefined) {
        dataElement.y = Math.round((1000 * lastSpeed * v * dv) / (60 * bo));
        dataset.data.push(dataElement);
      }

      lastSpeed = x;
      x = Math.round(x);

      dataset.data.push({
        x: x,
        y: mt
      });

      dataElement = {
        x: x,
        y: 0
      };
    });

    datasets.push(dataset);

    myChart = new Chart(ctx, {
      type: 'scatter',
      data: {
        datasets: datasets
      },
      options: {
        responsive: true,
        hoverMode: 'single',
        scales: {
          yAxes: [{
            scaleLabel: {
              display: true,
              labelString: "RPM"
            }
          }],
          xAxes: [{
            gridLines: {
              zeroLineColor: "rgba(0, 0, 0, 1)"
            },
            scaleLabel: {
              display: true,
              labelString: "KM/U"
            }
          }]
        },
        animation: {
          duration: 0
        }
      }

    });
    updateList();
  };

  function updateList() {
    var table;
    table = '<div class="col-lg-3"><table class="table table-striped">';

  $.each(datasets, function(index, dataset) {
    table = table + '<thead> <tr> <th colspan="3" class="text-center"><strong>' + dataset.label + '</strong></th> </tr>';
    table = table + '<tr> <th>versnelling</th> <th>km/u</th> <th>RPM</th> </tr> </thead> <tbody>';
    var lastSpeed = 0;
    var versnelling = 1;
    $.each(dataset.data, function(dsIndex, data) {

      if (data.x === 0 & data.y === 0) {
        table = table + '<tr>';
        return true;
      };

      if (lastSpeed === data.x) {
        table = table + '<td>' + data.y + '</td>';
        versnelling++;
        if (dsIndex !== dataset.data.length) {
          table = table + '</tr> <tr>';
        }
      } else {
        table = table + '<td>' + versnelling + '</td>';
        table = table + '<td>' + data.x + '</td>';
      };
      lastSpeed = data.x;
    });

    table = table + '<td></td></tr> </tbody>';
  });

  table = table + '</table></div>';

  $('#list').html(table);
console.log(table);
  };
</script>
</body>

</html>
